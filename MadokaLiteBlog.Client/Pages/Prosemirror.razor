@page "/prosemirror"
@page "/prosemirror/{Id:long}"
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>@(Id == null ? "新建文章" : "编辑文章")</PageTitle>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4">@(Id == null ? "创建新文章" : "编辑文章")</h2>
                    <EditForm Model="@post" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="form-group mb-4">
                            <label for="title" class="form-label fw-bold">标题</label>
                            <InputText id="title" @bind-Value="post.Title" class="form-control form-control-lg" placeholder="请输入文章标题..." />
                            <ValidationMessage For="@(() => post.Title)" class="text-danger" />
                        </div>

                        <div class="form-group mb-4">
                            <label for="summary" class="form-label fw-bold">摘要</label>
                            <InputTextArea id="summary" @bind-Value="post.Summary" class="form-control" rows="3" 
                                         placeholder="请输入文章摘要..." />
                            <ValidationMessage For="@(() => post.Summary)" class="text-danger" />
                        </div>
                        <div id="editor-container" style="border: 1px solid #ccc; padding: 10px;"></div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary me-2">保存草稿</button>
                            <button type="submit" class="btn btn-primary px-4">
                                @(Id == null ? "发布文章" : "更新文章")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>


<button @onclick="GetEditorContent">获取内容</button>

@code {
    [Parameter]
    public long? Id { get; set; }
    private Post post = new Post();
    private Timer? toastTimer;
    private string toastMessage = "";
    private IJSObjectReference? _editorInstance;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if(authState.User == null)
        {
            NavigationManager.NavigateTo("/login");
        }
    }
    
    private async Task LoadPost()
    {
        try
        {
            var response = await Http.PostAsync($"api/post/getbyid?id={Id}", new StringContent(""));
            if (response.IsSuccessStatusCode)
            {
                post = await response.Content.ReadFromJsonAsync<Post>() ?? new Post();
                await JS.InvokeVoidAsync("setEditorContent", post.Content);
            } 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading post: {ex.Message}");
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender)
        {
            _editorInstance = await JS.InvokeAsync<IJSObjectReference>("initializeEditor", "editor-container");
            if (Id.HasValue)
            {   
                await LoadPost();
            }
        }
    }
    private async Task GetEditorContent()
    {
        if (_editorInstance != null)
        {
            // 获取 JSON 对象
            var contentJson = await JS.InvokeAsync<JsonElement>("getEditorContent");
            var contentString = contentJson.GetRawText();
            Console.WriteLine($"Editor Content (Raw JSON): {contentString}");
            var markdownText = await JS.InvokeAsync<string>("getMarkdownContent"); 
            Console.WriteLine($"Markdown Content: {markdownText}");

        }
    }
    private async Task HandleValidSubmit()
    {
        try
        {
            HttpResponseMessage response;
            post.Content = await JS.InvokeAsync<string>("getMarkdownContent");
            if (Id.HasValue)
            {
                post.Id = Id.Value;
                response = await Http.PostAsJsonAsync("api/post/update", post);
                
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<int>();
                    if (result == 1)
                    {
                        ShowToast("文章更新成功！");
                        await Task.Delay(1500);
                        NavigationManager.NavigateTo($"/article/{Id}");
                        return;
                    }
                    else
                    {
                        ShowToast("更新失败");
                        return;
                    }
                }
            }
            response = await Http.PostAsJsonAsync("api/post/insert", post);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PostResponse>();
                if (result?.Id != null)
                {
                    ShowToast("文章发布成功！");
                    await Task.Delay(1500);
                    NavigationManager.NavigateTo($"/article/{result.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            ShowToast("保存失败：" + ex.Message);
        }
    }
    private void ShowToast(string message)
    {
        toastMessage = message;
        
        toastTimer?.Dispose();
        toastTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                StateHasChanged();
            });
        }, null, 3000, Timeout.Infinite);
    }
    private class PostResponse
    {
        public long Id { get; set; }
        public string? Title { get; set; }
    }

}
